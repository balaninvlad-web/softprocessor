#include <TXLib.h>
#include <stdio.h>
#include <assert.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>
#include <sys/stat.h>

#include "processor.h"

#define ERORRNULLBUFF 1
#define ERORRNULLSTK1 2

int verificator_pro(my_pro_t* str_pro, const char* file, const char* func, int line, int command);
//int DumpPro(my_pro_t* str_pro, int i, const char* file, const char* func, int line);
//int ProcessorCtor(my_pro_t* str_pro);

int* read_from_file(my_pro_t* str_pro, const char* TEST, size_t* size_of_buffer)
{
    FILE* input_file = fopen(TEST, "rb");

    assert(input_file != NULL);

    struct stat statbuf ={};

    stat (TEST, &statbuf);

    *size_of_buffer = statbuf.st_size;

    assert(*size_of_buffer != 0);

    $(*size_of_buffer);

    str_pro->buffer = (int*)calloc(*size_of_buffer + 1, sizeof(char));

    str_pro->buffer[*size_of_buffer] = '\0';

    fread(str_pro->buffer, sizeof(int), *size_of_buffer, input_file);

    #ifdef DEBUG
        for (size_t i = 0; i < *size_of_buffer/4 ; i++)
        {
            fprintf(stderr, "%d |i = %d|\n",str_pro->buffer[i], i);
        }
    #endif

    return str_pro->buffer;
}

int ProcessorCtor (my_pro_t* str_pro)
{
    assert(str_pro);

    size_t size_of_buffer = 0;

    const char* TEST = "mashine_code_bin4.bin";

    if (StackCtor(&str_pro->stk1, 6) != NOERORR)
    {
        return ERORRDATANULL;
    }

    if (StackCtor(&str_pro->stk_call, 6) != NOERORR)
    {
        return ERORRDATANULL;
    }

    str_pro->buffer = read_from_file(str_pro, TEST, &size_of_buffer);

    str_pro->ip = 0;s

    st_pro->Ram_Mem [100] ={};

    #ifdef DEBUG
        verificator_pro (str_pro, __FILE__, __func__ ,__LINE__, -1);
    #endif


    return NOERORR;
}

int verificator_pro (my_pro_t* str_pro, const char* file, const char* func, int line, int command)
{
    int i = 0;
    if (str_pro->buffer == NULL)
    {
        i |= ERORRNULLBUFF;
    }
    if (i > 0)
    {
        DumpPro(str_pro, i, file, func, line, command);
    }
    return i;
}

int DumpPro (my_pro_t* str_pro,int i, const char* file, const char* func, int line, int command)
{
    fprintf(stderr, "----------------------------DUMBPROCESSOR\n\n");

    fprintf(stderr, "code: %d\n", command);

    fprintf(stderr, "pos ip: %lu\n", (unsigned long)str_pro->ip);

    fprintf(stderr, "called in file: %s, function: %s, in line: %d", file, func, line);

    fprintf(stderr, "[%p]\n", (void*)str_pro);
    
    fprintf(strerr, "RAM_mem:\n");
    
    for(int i; i < RAM_SIZE; i++)
    {
        printf("[%d] %")
    }

    verificator (&str_pro->stk1,  file, func, line);

    StackDump(&str_pro->stk1, i, file, func, line);

    fprintf(stderr, "----------------------------DUMBPROCESSOREND\n\n");

    return 0;
}
